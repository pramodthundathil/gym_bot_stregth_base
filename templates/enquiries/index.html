<!-- Today's Follow-ups Section -->
          <div class="row mb-4">
            <div class="col-12">
              {% extends 'index.html' %}

{% block content %}
<style>
  .status-pending {
    background-color: #ffc107;
    color: #000;
  }

  .status-completed {
    background-color: #28a745;
    color: #fff;
  }

  .status-in_progress {
    background-color: #007bff;
    color: #fff;
  }

  .status-not_required {
    background-color: #6c757d;
    color: #fff;
  }

  .status-rejected {
    background-color: #dc3545;
    color: #fff;
  }

  .call-status-rnr {
    background-color: #fd7e14;
    color: #fff;
  }

  .call-status-callback {
    background-color: #20c997;
    color: #fff;
  }

  .call-status-interested {
    background-color: #0dcaf0;
    color: #000;
  }

  .call-status-not_interested {
    background-color: #6f42c1;
    color: #fff;
  }

  .call-status-converted {
    background-color: #198754;
    color: #fff;
  }

  .call-status-follow_up {
    background-color: #ffc107;
    color: #000;
  }

  .call-status-closed {
    background-color: #adb5bd;
    color: #000;
  }

  .sidebar {
    min-height: 100vh;
    background-color: #f8f9fa;
  }

  .main-content {
    padding: 20px;
  }

  .card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: 1px solid rgba(0, 0, 0, 0.125);
    transition: transform 0.2s;
  }

  .card:hover {
    transform: translateY(-2px);
  }

  .badge-status {
    font-size: 0.75em;
    padding: 0.5em 0.75em;
    border-radius: 0.375rem;
  }

  .stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
  }

  .stat-card.conversion {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  }

  .stat-card.pending {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  }

  .stat-card.followup {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
  }

  .progress-ring {
    width: 60px;
    height: 60px;
  }

  .link-through-enquiry {
    gap: 10px;
    flex-wrap: wrap;
  }

  .link-through-enquiry a {
    flex: 1;
    min-width: 200px;
    text-align: center;
    margin-bottom: 10px;
  }

  .dashboard-stat {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
  }

  .chart-container {
    position: relative;
    height: 300px;
  }
</style>

<div class="main-panel">
  <div class="content-wrapper pb-0">
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-12 col-lg-12">
          <div class="d-flex flex-column p-3">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h4 class="mb-0"><i class="fas fa-clipboard-list"></i> Enquiry Dashboard</h4>
              <div class="text-muted">
                <i class="fas fa-calendar"></i> {{ today|date:"M d, Y" }}
              </div>
            </div>
            
            <div class="d-flex justify-content-between link-through-enquiry mb-4">
              <a href="{% url 'enquiry_list' %}"
                class="nav-link {% if 'enquiry_list' in request.resolver_match.url_name %}active{% endif %} btn btn-primary">
                <i class="fas fa-list"></i> All Enquiries
              </a>
              <a href="{% url 'enquiry_create' %}"
                class="nav-link {% if 'enquiry_create' in request.resolver_match.url_name %}active{% endif %} btn btn-primary">
                <i class="fas fa-plus"></i> New Enquiry
              </a>
              <a href="{% url 'todays_followups' %}" class="nav-link btn btn-warning">
                <i class="fas fa-calendar-check"></i> Today's Follow-ups
                {% if needs_followup > 0 %}
                  <span class="badge bg-danger ms-1">{{ needs_followup }}</span>
                {% endif %}
              </a>
              <a href="{% url 'enquiry_list' %}?conversion=False" class="nav-link btn btn-primary">
                <i class="fas fa-clock"></i> Pending Conversions
              </a>
              <a href="{% url 'enquiry_list' %}?conversion=True" class="nav-link btn btn-primary">
                <i class="fas fa-check-circle"></i> Converted
              </a>
            </div>
          </div>

          <!-- Statistics Cards -->
          <div class="row mb-4">
            <div class="col-xl-3 col-md-6 mb-3">
              <div class="card stat-card">
                <div class="card-body">
                  <div class="d-flex justify-content-between">
                    <div>
                      <div class="dashboard-stat">{{ total_enquiries }}</div>
                      <div>Total Enquiries</div>
                      <small class="text-white-50">
                        <i class="fas fa-calendar"></i> This Month: {{ this_month_enquiries }}
                      </small>
                    </div>
                    <div class="align-self-center">
                      <i class="fas fa-users fa-2x opacity-50"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-3">
              <div class="card stat-card conversion">
                <div class="card-body">
                  <div class="d-flex justify-content-between">
                    <div>
                      <div class="dashboard-stat">{{ converted_enquiries }}</div>
                      <div>Converted</div>
                      <small class="text-white-50">
                        <i class="fas fa-percentage"></i> Rate: {{ conversion_rate }}%
                      </small>
                    </div>
                    <div class="align-self-center">
                      <i class="fas fa-check-circle fa-2x opacity-50"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-3">
              <div class="card stat-card pending">
                <div class="card-body">
                  <div class="d-flex justify-content-between">
                    <div>
                      <div class="dashboard-stat">{{ pending_enquiries }}</div>
                      <div>Pending</div>
                      <small class="text-white-50">
                        <i class="fas fa-clock"></i> Need Follow-up: {{ needs_followup }}
                      </small>
                    </div>
                    <div class="align-self-center">
                      <i class="fas fa-hourglass-half fa-2x opacity-50"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-3">
              <div class="card stat-card followup">
                <div class="card-body">
                  <div class="d-flex justify-content-between">
                    <div>
                      <div class="dashboard-stat">{{ total_followups }}</div>
                      <div>Total Follow-ups</div>
                      <small class="text-white-50">
                        <i class="fas fa-chart-line"></i> Avg: {{ avg_followups }} per enquiry
                      </small>
                    </div>
                    <div class="align-self-center">
                      <i class="fas fa-phone fa-2x opacity-50"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Today's Follow-ups Section -->
          <div class="row mb-4">
            <div class="col-12">
              <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <h5 class="card-title mb-0">
                    <i class="fas fa-calendar-check"></i> Today's Follow-ups
                    {% if needs_followup > 0 %}
                      <span class="badge bg-danger ms-2">{{ needs_followup }} due</span>
                    {% endif %}
                    {% if overdue_followups > 0 %}
                      <span class="badge bg-warning ms-1">{{ overdue_followups }} overdue</span>
                    {% endif %}
                  </h5>
                  <a href="{% url 'todays_followups' %}" class="btn btn-sm btn-outline-primary">
                    View All Follow-ups
                  </a>
                </div>
                <div class="card-body">
                  {% if todays_pending_followups %}
                    <div class="row">
                      {% for enquiry in todays_pending_followups %}
                        <div class="col-lg-4 col-md-6 mb-3">
                          <div class="card border-left-warning">
                            <div class="card-body p-3">
                              <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                  <h6 class="mb-1">
                                    <a href="{% url 'enquiry_detail' enquiry.pk %}" class="text-decoration-none">
                                      {{ enquiry.name|truncatechars:20 }}
                                    </a>
                                  </h6>
                                  <div class="small text-muted mb-2">
                                    <i class="fas fa-phone"></i> {{ enquiry.phone_number }}
                                  </div>
                                  <div class="mb-2">
                                    <span class="badge status-{{ enquiry.status }} badge-status small">
                                      {{ enquiry.get_status_display }}
                                    </span>
                                  </div>
                                  <small class="text-muted">
                                    {% if enquiry.next_follow_up_date < today %}
                                      <i class="fas fa-exclamation-triangle text-danger"></i>
                                      {{ enquiry.next_follow_up_date|timesince:today }} overdue
                                    {% elif enquiry.next_follow_up_date == today %}
                                      <i class="fas fa-clock text-warning"></i> Due today
                                    {% endif %}
                                  </small>
                                </div>
                                <div class="dropdown">
                                  <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                                          data-bs-toggle="dropdown">
                                    <i class="fas fa-ellipsis-v"></i>
                                  </button>
                                  <ul class="dropdown-menu dropdown-menu-end">
                                    <li>
                                      <a class="dropdown-item" href="{% url 'enquiry_detail' enquiry.pk %}">
                                        <i class="fas fa-eye"></i> View Details
                                      </a>
                                    </li>
                                    <li>
                                      <a class="dropdown-item" href="{% url 'add_status_update' enquiry.pk %}">
                                        <i class="fas fa-plus"></i> Add Follow-up
                                      </a>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                      <a class="dropdown-item" href="tel:{{ enquiry.phone_number }}">
                                        <i class="fas fa-phone"></i> Call Now
                                      </a>
                                    </li>
                                    {% if enquiry.email %}
                                      <li>
                                        <a class="dropdown-item" href="mailto:{{ enquiry.email }}">
                                          <i class="fas fa-envelope"></i> Send Email
                                        </a>
                                      </li>
                                    {% endif %}
                                  </ul>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                    
                    {% if needs_followup > 5 %}
                      <div class="text-center mt-3">
                        <a href="{% url 'todays_followups' %}" class="btn btn-warning">
                          <i class="fas fa-calendar-check"></i> 
                          View All {{ needs_followup }} Follow-ups
                        </a>
                      </div>
                    {% endif %}
                  {% else %}
                    <div class="text-center py-3">
                      <i class="fas fa-calendar-check fa-2x text-success mb-2"></i>
                      <h6 class="text-success">All caught up!</h6>
                      <p class="text-muted mb-0">No follow-ups due today.</p>
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <!-- Charts and Breakdowns -->
          <div class="row mb-4">
            <div class="col-lg-6 mb-3">
              <div class="card">
                <div class="card-header">
                  <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie"></i> Status Breakdown
                  </h5>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-lg-6 mb-3">
              <div class="card">
                <div class="card-header">
                  <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar"></i> Monthly Trend
                  </h5>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="monthlyChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Recent Activity -->
          <div class="row">
            <div class="col-lg-6 mb-3">
              <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <h5 class="card-title mb-0">
                    <i class="fas fa-clock"></i> Recent Enquiries
                  </h5>
                  <a href="{% url 'enquiry_list' %}" class="btn btn-sm btn-outline-primary">View All</a>
                </div>
                <div class="card-body">
                  {% if recent_enquiries_list %}
                    <div class="table-responsive">
                      <table class="table table-sm">
                        <thead>
                          <tr>
                            <th>Name</th>
                            <th>Phone</th>
                            <th>Status</th>
                            <th>Date</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for enquiry in recent_enquiries_list %}
                            <tr>
                              <td>
                                <a href="{% url 'enquiry_detail' enquiry.pk %}" class="text-decoration-none">
                                  {{ enquiry.name|truncatechars:20 }}
                                </a>
                              </td>
                              <td>{{ enquiry.phone_number }}</td>
                              <td>
                                <span class="badge status-{{ enquiry.status }} badge-status">
                                  {{ enquiry.get_status_display }}
                                </span>
                              </td>
                              <td>{{ enquiry.date_created|date:"M d" }}</td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  {% else %}
                    <div class="text-center py-3">
                      <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                      <p class="text-muted">No recent enquiries</p>
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="col-lg-6 mb-3">
              <div class="card">
                <div class="card-header">
                  <h5 class="card-title mb-0">
                    <i class="fas fa-comments"></i> Recent Follow-ups
                  </h5>
                </div>
                <div class="card-body">
                  {% if recent_followups %}
                    {% for followup in recent_followups %}
                      <div class="mb-3 pb-3 {% if not forloop.last %}border-bottom{% endif %}">
                        <div class="d-flex justify-content-between align-items-start">
                          <div>
                            <strong>
                              <a href="{% url 'enquiry_detail' followup.enquiry.pk %}" class="text-decoration-none">
                                {{ followup.enquiry.name }}
                              </a>
                            </strong>
                            <div class="small text-muted">{{ followup.description|truncatechars:60 }}</div>
                          </div>
                          <div class="text-end">
                            <span class="badge call-status-{{ followup.call_status }}">
                              {{ followup.get_call_status_display }}
                            </span>
                            <div class="small text-muted">{{ followup.date_of_status|date:"M d" }}</div>
                          </div>
                        </div>
                      </div>
                    {% endfor %}
                  {% else %}
                    <div class="text-center py-3">
                      <i class="fas fa-comment-slash fa-2x text-muted mb-2"></i>
                      <p class="text-muted">No recent follow-ups</p>
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="row">
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <h5 class="card-title mb-0">
                    <i class="fas fa-bolt"></i> Quick Actions
                  </h5>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-3 mb-2">
                      <a href="{% url 'todays_followups' %}" 
                         class="btn btn-warning btn-block">
                        <i class="fas fa-calendar-check"></i> Today's Follow-ups
                        {% if needs_followup > 0 %}
                          <span class="badge bg-danger ms-1">{{ needs_followup }}</span>
                        {% endif %}
                      </a>
                    </div>
                    <div class="col-md-3 mb-2">
                      <a href="{% url 'enquiry_list' %}?conversion=False&status=pending" 
                         class="btn btn-outline-warning btn-block">
                        <i class="fas fa-exclamation-triangle"></i> Pending Enquiries
                      </a>
                    </div>
                    <div class="col-md-3 mb-2">
                      <a href="{% url 'enquiry_list' %}?conversion=False&status=in_progress" 
                         class="btn btn-outline-primary btn-block">
                        <i class="fas fa-spinner"></i> In Progress
                      </a>
                    </div>
                    <div class="col-md-3 mb-2">
                      <a href="{% url 'enquiry_create' %}" 
                         class="btn btn-success btn-block">
                        <i class="fas fa-plus"></i> Add New Enquiry
                      </a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer class="footer">
      <div class="d-sm-flex justify-content-center justify-content-sm-between">
        <span class="text-muted d-block text-center text-sm-left d-sm-inline-block">Copyright © Byteboot Techno
          Solutions Pvt Ltd</span>
        <span class="float-none float-sm-right d-block mt-1 mt-sm-0 text-center"> Developed By <a
            href="https://www.byteboot.in/" target="_blank">Byteboot Techno Solutions Pvt Ltd</a></span>
      </div>
    </footer>
  </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<script>
  // Status Breakdown Pie Chart
  const statusCtx = document.getElementById('statusChart').getContext('2d');
  new Chart(statusCtx, {
    type: 'doughnut',
    data: {
      labels: [
        {% for status in status_breakdown %}
          '{{ status.status|capfirst }}'{% if not forloop.last %},{% endif %}
        {% endfor %}
      ],
      datasets: [{
        data: [
          {% for status in status_breakdown %}
            {{ status.count }}{% if not forloop.last %},{% endif %}
          {% endfor %}
        ],
        backgroundColor: [
          '#ffc107', '#28a745', '#007bff', '#6c757d', '#dc3545'
        ],
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom'
        }
      }
    }
  });

  // Monthly Trend Chart
  const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
  new Chart(monthlyCtx, {
    type: 'line',
    data: {
      labels: [
        {% for month in monthly_data %}
          '{{ month.month }}'{% if not forloop.last %},{% endif %}
        {% endfor %}
      ],
      datasets: [{
        label: 'Enquiries',
        data: [
          {% for month in monthly_data %}
            {{ month.enquiries }}{% if not forloop.last %},{% endif %}
          {% endfor %}
        ],
        borderColor: '#007bff',
        backgroundColor: 'rgba(0, 123, 255, 0.1)',
        tension: 0.3
      }, {
        label: 'Conversions',
        data: [
          {% for month in monthly_data %}
            {{ month.conversions }}{% if not forloop.last %},{% endif %}
          {% endfor %}
        ],
        borderColor: '#28a745',
        backgroundColor: 'rgba(40, 167, 69, 0.1)',
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'top'
        }
      },
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });
</script>

{% endblock %}